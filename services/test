import { Resend } from 'resend';

const FROM_EMAIL = 'no-reply@sapavault.com';
const resend = new Resend(process.env.RESEND_API_KEY);

// ============================================
// EMAIL TEMPLATES (FIXED STRUCTURE)
// ============================================

const emailTemplates = {
    // 1. OTP VERIFICATION EMAIL
    otpVerification: (data) => ({
        subject: 'Verify Your Email - HelpMarq',
        html: `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Email - HelpMarq</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #F2F2F7;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #F2F2F7; padding: 40px 20px;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #FFFFFF; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <tr>
                        <td style="padding: 40px 40px 24px; text-align: center; border-bottom: 1px solid #F2F2F7;">
                            <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #2C5EF0;">HelpMarq</h1>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 40px;">
                            <h2 style="margin: 0 0 16px; font-size: 24px; font-weight: 700; color: #1C1C1E;">Verify Your Email</h2>
                            <p style="margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #8E8E93;">Enter this verification code to complete your registration:</p>
                            <div style="background-color: #F2F2F7; border-radius: 12px; padding: 24px; text-align: center; margin: 0 0 24px;">
                                <p style="margin: 0 0 8px; font-size: 14px; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Your Code</p>
                                <p style="margin: 0; font-size: 48px; font-weight: 700; color: #2C5EF0; letter-spacing: 8px; font-family: 'Courier New', monospace;">${data.code}</p>
                            </div>
                            <p style="margin: 0 0 16px; font-size: 14px; line-height: 1.6; color: #8E8E93;">This code will expire in <strong style="color: #1C1C1E;">10 minutes</strong>.</p>
                            <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #8E8E93;">If you didn't request this code, please ignore this email.</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 24px 40px; background-color: #F2F2F7; border-radius: 0 0 16px 16px; text-align: center;">
                            <p style="margin: 0; font-size: 12px; color: #8E8E93;">¬© 2026 HelpMarq. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
        `
    }),

    // 2. WELCOME PROJECT OWNER EMAIL
    welcomeOwner: (data) => ({
        subject: 'Welcome to HelpMarq!',
        html: `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to HelpMarq</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #F2F2F7;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #F2F2F7; padding: 40px 20px;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #FFFFFF; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <tr>
                        <td style="padding: 40px 40px 24px; text-align: center; border-bottom: 1px solid #F2F2F7;">
                            <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #2C5EF0;">HelpMarq</h1>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 40px;">
                            <h2 style="margin: 0 0 16px; font-size: 24px; font-weight: 700; color: #1C1C1E;">Welcome, ${data.name}! üëã</h2>
                            <p style="margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #8E8E93;">Your account has been created successfully. You're now ready to submit projects and receive multi-perspective feedback from our trusted reviewer community.</p>
                            <div style="background-color: #F2F2F7; border-radius: 12px; padding: 24px; margin: 0 0 24px;">
                                <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 700; color: #1C1C1E;">What's Next?</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #8E8E93; line-height: 1.8;">
                                    <li><strong style="color: #1C1C1E;">Submit Your First Project</strong> - Upload your work and set a deadline</li>
                                    <li><strong style="color: #1C1C1E;">Select Reviewers</strong> - Choose from expert, mid-level, or user perspectives</li>
                                    <li><strong style="color: #1C1C1E;">Receive Feedback</strong> - Get actionable insights to improve your project</li>
                                </ul>
                            </div>
                            <table width="100%" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td align="center">
                                        <a href="https://helpmarq-frontend.vercel.app" style="display: inline-block; padding: 14px 32px; background-color: #2C5EF0; color: #FFFFFF; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">Go to Dashboard</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 24px 40px; background-color: #F2F2F7; border-radius: 0 0 16px 16px; text-align: center;">
                            <p style="margin: 0; font-size: 12px; color: #8E8E93;">¬© 2026 HelpMarq. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
        `
    }),

    // 3. WELCOME REVIEWER EMAIL
    welcomeReviewer: (data) => ({
        subject: 'Welcome to HelpMarq - Start Reviewing!',
        html: `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to HelpMarq</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #F2F2F7;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #F2F2F7; padding: 40px 20px;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #FFFFFF; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <tr>
                        <td style="padding: 40px 40px 24px; text-align: center; border-bottom: 1px solid #F2F2F7;">
                            <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #2C5EF0;">HelpMarq</h1>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 40px;">
                            <h2 style="margin: 0 0 16px; font-size: 24px; font-weight: 700; color: #1C1C1E;">Welcome, ${data.name}! üåü</h2>
                            <p style="margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #8E8E93;">Your reviewer profile has been created successfully. Start earning XP by providing valuable feedback to project owners.</p>
                            <div style="background-color: #F2F2F7; border-radius: 12px; padding: 24px; margin: 0 0 24px;">
                                <h3 style="margin: 0 0 16px; font-size: 18px; font-weight: 700; color: #1C1C1E;">How It Works</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #8E8E93; line-height: 1.8;">
                                    <li><strong style="color: #1C1C1E;">Browse Available Projects</strong> - Find projects matching your expertise</li>
                                    <li><strong style="color: #1C1C1E;">Apply to Review</strong> - Submit applications for projects you're interested in</li>
                                    <li><strong style="color: #1C1C1E;">Provide Feedback</strong> - Share your insights and earn XP</li>
                                    <li><strong style="color: #1C1C1E;">Build Your Reputation</strong> - Higher ratings unlock more opportunities</li>
                                </ul>
                            </div>
                            <table width="100%" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td align="center">
                                        <a href="https://helpmarq-frontend.vercel.app" style="display: inline-block; padding: 14px 32px; background-color: #2C5EF0; color: #FFFFFF; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">Start Reviewing</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 24px 40px; background-color: #F2F2F7; border-radius: 0 0 16px 16px; text-align: center;">
                            <p style="margin: 0; font-size: 12px; color: #8E8E93;">¬© 2026 HelpMarq. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
        `
    }),

    // 4-9. OTHER TEMPLATES (Same pattern - returning objects with subject + html)
    applicationReceived: (data) => ({
        subject: `New Application for ${data.projectTitle}`,
        html: `[Previous HTML content for applicationReceived - keeping same structure]`
    }),

    applicationApproved: (data) => ({
        subject: 'Your Application Was Approved!',
        html: `[Previous HTML content]`
    }),

    applicationRejected: (data) => ({
        subject: 'Application Status Update',
        html: `[Previous HTML content]`
    }),

    projectSubmitted: (data) => ({
        subject: 'Project Submitted Successfully',
        html: `[Previous HTML content]`
    }),

    reviewComplete: (data) => ({
        subject: `New Feedback on ${data.projectTitle}`,
        html: `[Previous HTML content]`
    }),

    ratingReceived: (data) => ({
        subject: 'You Received a Rating!',
        html: `[Previous HTML content]`
    })
};

// ============================================
// SEND EMAIL FUNCTION (FIXED)
// ============================================

async function sendEmail(templateName, to, data) {
    try {
        console.log(`üìß Preparing email: ${templateName} to ${to}`);
        
        if (!emailTemplates[templateName]) {
            throw new Error(`Email template "${templateName}" not found`);
        }
        
        // ‚úÖ FIX: Templates now return objects with subject and html
        const template = emailTemplates[templateName](data);

        console.log(`üì® Subject: ${template.subject}`);
        console.log(`üì§ Sending via Resend...`);

        const result = await resend.emails.send({
            from: FROM_EMAIL,
            to: to,
            subject: template.subject,
            html: template.html
        });

        console.log(`‚úÖ Email sent successfully: ${templateName} to ${to}`);
        console.log(`üì¨ Resend ID:`, result.id);
        
        return { success: true, id: result.id };
    } catch (error) {
        console.error(`‚ùå Email failed: ${templateName} to ${to}`);
        console.error(`Error message: ${error.message}`);
        
        return { success: false, error: error.message };
    }
}

// ============================================
// EXPORT FUNCTIONS (FIXED TEMPLATE NAMES)
// ============================================

export async function sendOTPEmail(email, code) {
    // ‚úÖ FIX: Correct template name
    return sendEmail('otpVerification', email, { code });
}

export async function sendWelcomeEmail(user, role) {
    const templateName = role === 'reviewer' ? 'welcomeReviewer' : 'welcomeOwner';
    return sendEmail(templateName, user.email, { name: user.name });
}

export async function sendApplicationReceivedEmail(ownerEmail, data) {
    return sendEmail('applicationReceived', ownerEmail, data);
}

export async function sendApplicationApprovedEmail(reviewerEmail, data) {
    return sendEmail('applicationApproved', reviewerEmail, data);
}

export async function sendApplicationRejectedEmail(reviewerEmail, data) {
    return sendEmail('applicationRejected', reviewerEmail, data);
}

export async function sendProjectSubmittedEmail(project) {
    return sendEmail('projectSubmitted', project.ownerEmail, {
        ownerName: project.ownerName,
        projectTitle: project.title
    });
}

export async function sendReviewCompleteEmail(project, feedback, reviewer) {
    return sendEmail('reviewComplete', project.ownerEmail, {
        ownerName: project.ownerName,
        reviewerName: reviewer.username,
        projectTitle: project.title
    });
}

export async function sendRatingReceivedEmail(reviewer, feedback, project) {
    return sendEmail('ratingReceived', reviewer.email, {
        reviewerName: reviewer.username,
        projectTitle: project.title,
        rating: feedback.ownerRating,
        xpAwarded: feedback.xpAwarded
    });
}

// Placeholder functions
export async function sendReviewAssignedEmail() {
    console.log('üìß sendReviewAssignedEmail called (placeholder)');
    return { success: true };
}

export async function sendFeedbackSubmittedEmail() {
    console.log('üìß sendFeedbackSubmittedEmail called (placeholder)');
    return { success: true };
}